<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مرجع خرید اپل آیدی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'vazir': ['Vazir', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Vazir:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazir', sans-serif; }
        .apple-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .usa-flag { background: linear-gradient(45deg, #B22234 25%, transparent 25%), linear-gradient(-45deg, #B22234 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #B22234 75%), linear-gradient(-45deg, transparent 75%, #B22234 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; }
        .uk-flag { background: linear-gradient(45deg, #012169 25%, #FFFFFF 25%, #FFFFFF 50%, #CE1124 50%, #CE1124 75%, #FFFFFF 75%), linear-gradient(-45deg, #012169 25%, #FFFFFF 25%, #FFFFFF 50%, #CE1124 50%, #CE1124 75%, #FFFFFF 75%); background-size: 40px 40px; }
        .admin-panel { display: none; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="apple-gradient text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <svg class="w-10 h-10" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                    </svg>
                    <h1 class="text-2xl font-bold">مرجع خرید اپل آیدی</h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button onclick="showLogin()" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition">ورود</button>
                    <button onclick="showRegister()" class="border border-white px-4 py-2 rounded-lg hover:bg-white hover:text-blue-600 transition">ثبت نام</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Hero Section -->
        <div class="text-center mb-12">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">بهترین اپل آیدی های آماده</h2>
            <p class="text-xl text-gray-600">تمام اپل آیدی ها با قیمت ثابت ۱۴۹,۰۰۰ تومان</p>
        </div>

        <!-- Apple ID Products -->
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
            <!-- USA Apple ID -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition">
                <div class="usa-flag h-32 relative">
                    <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                        <span class="text-white text-2xl font-bold">🇺🇸 USA</span>
                    </div>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold mb-2">اپل آیدی آمریکا</h3>
                    <p class="text-gray-600 mb-4">دسترسی کامل به اپ استور آمریکا</p>
                    <div class="flex justify-between items-center">
                        <span class="text-2xl font-bold text-green-600">۱۴۹,۰۰۰ تومان</span>
                        <button onclick="buyAppleId('USA')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">خرید</button>
                    </div>
                </div>
            </div>

            <!-- UK Apple ID -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition">
                <div class="uk-flag h-32 relative">
                    <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                        <span class="text-white text-2xl font-bold">🇬🇧 UK</span>
                    </div>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold mb-2">اپل آیدی انگلستان</h3>
                    <p class="text-gray-600 mb-4">دسترسی کامل به اپ استور انگلستان</p>
                    <div class="flex justify-between items-center">
                        <span class="text-2xl font-bold text-green-600">۱۴۹,۰۰۰ تومان</span>
                        <button onclick="buyAppleId('UK')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">خرید</button>
                    </div>
                </div>
            </div>

            <!-- Canada Apple ID -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition">
                <div class="h-32 relative" style="background: linear-gradient(to right, #FF0000 33%, #FFFFFF 33%, #FFFFFF 66%, #FF0000 66%);">
                    <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                        <span class="text-white text-2xl font-bold">🇨🇦 CANADA</span>
                    </div>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold mb-2">اپل آیدی کانادا</h3>
                    <p class="text-gray-600 mb-4">دسترسی کامل به اپ استور کانادا</p>
                    <div class="flex justify-between items-center">
                        <span class="text-2xl font-bold text-green-600">۱۴۹,۰۰۰ تومان</span>
                        <button onclick="buyAppleId('CANADA')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">خرید</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Reviews -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-12">
            <h3 class="text-2xl font-bold mb-6 text-center">نظرات مشتریان</h3>
            <div id="reviews" class="space-y-6">
                <!-- نظرات از Firebase لود می‌شوند -->
            </div>
            
            <div class="mt-6 border-t pt-6">
                <h4 class="font-semibold mb-3">نظر خود را بنویسید:</h4>
                <textarea id="newComment" class="w-full p-3 border rounded-lg resize-none" rows="3" placeholder="نظر شما..."></textarea>
                <button onclick="addComment()" class="mt-3 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">ارسال نظر</button>
            </div>
        </div>

        <!-- Trust Badges -->
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h3 class="text-2xl font-bold mb-6 text-center">تاییدیه های اعتباری</h3>
            <div class="flex justify-center items-center space-x-8 space-x-reverse flex-wrap gap-4">
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center text-white text-2xl">✓</div>
                    <span class="text-sm mt-2">نماد اعتماد</span>
                </div>
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl">🔒</div>
                    <span class="text-sm mt-2">پرداخت امن</span>
                </div>
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-purple-500 rounded-full flex items-center justify-center text-white text-2xl">⚡</div>
                    <span class="text-sm mt-2">تحویل سریع</span>
                </div>
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-orange-500 rounded-full flex items-center justify-center text-white text-2xl">📞</div>
                    <span class="text-sm mt-2">پشتیبانی ۲۴/۷</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-4">برای ارتباط با ما:</p>
            <a href="https://t.me/ILI_A_721" target="_blank" class="inline-flex items-center space-x-2 space-x-reverse bg-blue-500 px-6 py-3 rounded-lg hover:bg-blue-600 transition">
                <span>📱</span>
                <span>@ILI_A_721</span>
            </a>
            <p class="mt-6 text-gray-400">© ۲۰۲۴ مرجع خرید اپل آیدی - تمامی حقوق محفوظ است</p>
        </div>
    </footer>

    <!-- Modals -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close float-left text-2xl cursor-pointer" onclick="closeModal('loginModal')">&times;</span>
            <h2 class="text-2xl font-bold mb-4">ورود به حساب کاربری</h2>
            <form onsubmit="login(event)">
                <input type="email" id="loginEmail" placeholder="ایمیل" class="w-full p-3 border rounded-lg mb-4" required>
                <input type="password" id="loginPassword" placeholder="رمز عبور" class="w-full p-3 border rounded-lg mb-4" required>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">ورود</button>
            </form>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close float-left text-2xl cursor-pointer" onclick="closeModal('registerModal')">&times;</span>
            <h2 class="text-2xl font-bold mb-4">ثبت نام</h2>
            <form onsubmit="register(event)">
                <input type="text" id="registerName" placeholder="نام و نام خانوادگی" class="w-full p-3 border rounded-lg mb-4" required>
                <input type="email" id="registerEmail" placeholder="ایمیل" class="w-full p-3 border rounded-lg mb-4" required>
                <input type="password" id="registerPassword" placeholder="رمز عبور" class="w-full p-3 border rounded-lg mb-4" required>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition">ثبت نام</button>
            </form>
        </div>
    </div>

    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <span class="close float-left text-2xl cursor-pointer" onclick="closeModal('purchaseModal')">&times;</span>
            <h2 class="text-2xl font-bold mb-4">خرید اپل آیدی</h2>
            <div id="purchaseContent">
                <p class="mb-4">اپل آیدی <span id="countryName"></span></p>
                <p class="text-2xl font-bold text-green-600 mb-6">قیمت: ۱۴۹,۰۰۰ تومان</p>
                <button onclick="processPayment()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition mb-4">پرداخت</button>
                <div id="paymentResult" class="hidden">
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                        پرداخت با موفقیت انجام شد!
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h4 class="font-bold mb-2">اطلاعات اپل آیدی شما:</h4>
                        <p><strong>ایمیل:</strong> <span id="appleEmail"></span></p>
                        <p><strong>رمز عبور:</strong> <span id="applePassword"></span></p>
                        <p class="text-sm text-gray-600 mt-2">لطفاً این اطلاعات را در جای امنی نگهداری کنید</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close float-left text-2xl cursor-pointer" onclick="closeModal('dashboardModal')">&times;</span>
            <h2 class="text-2xl font-bold mb-6">پنل کاربری</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-4">تاریخچه خریدها</h3>
                    <div id="purchaseHistory" class="space-y-3">
                        <!-- تاریخچه خریدها از Firebase لود می‌شود -->
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">اطلاعات حساب</h3>
                    <div class="space-y-2">
                        <p><strong>نام:</strong> <span id="userName">کاربر محترم</span></p>
                        <p><strong>ایمیل:</strong> <span id="userEmail">user@example.com</span></p>
                        <p><strong>تاریخ عضویت:</strong> <span id="memberSince">۱۴۰۳/۰۵/۲۸</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel fixed inset-0 bg-black bg-opacity-90 z-50">
        <div class="container mx-auto px-4 py-8">
            <div class="bg-white rounded-xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">پنل مدیریت</h2>
                    <button onclick="closeAdminPanel()" class="text-red-600 text-2xl">&times;</button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">افزودن اپل آیدی جدید</h3>
                        <form onsubmit="addAppleId(event)">
                            <select id="appleIdCountry" class="w-full p-3 border rounded-lg mb-4" required>
                                <option value="">انتخاب کشور</option>
                                <option value="USA">آمریکا</option>
                                <option value="UK">انگلستان</option>
                                <option value="CANADA">کانادا</option>
                            </select>
                            <input type="email" id="appleIdEmail" placeholder="ایمیل اپل آیدی" class="w-full p-3 border rounded-lg mb-4" required>
                            <input type="password" id="appleIdPassword" placeholder="رمز عبور" class="w-full p-3 border rounded-lg mb-4" required>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">افزودن</button>
                        </form>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-4">آمار فروش</h3>
                        <div class="space-y-3">
                            <div class="bg-green-100 p-3 rounded-lg">
                                <p class="font-semibold">فروش امروز: <span id="todaySales">0</span> عدد</p>
                                <p class="text-sm text-gray-600">درآمد: <span id="todayRevenue">0</span> تومان</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-lg">
                                <p class="font-semibold">فروش این ماه: <span id="monthSales">0</span> عدد</p>
                                <p class="text-sm text-gray-600">درآمد: <span id="monthRevenue">0</span> تومان</p>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-lg">
                                <p class="font-semibold">موجودی کل:</p>
                                <p class="text-sm text-gray-600">
                                    آمریکا: <span id="usaStock">0</span> | 
                                    انگلستان: <span id="ukStock">0</span> | 
                                    کانادا: <span id="canadaStock">0</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // پیکربندی Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBcbE7KwEiUw57e3_xCBLOflfJOOTMlEKc",
            authDomain: "myappleid-ee18a.firebaseapp.com",
            databaseURL: "https://myappleid-ee18a-default-rtdb.firebaseio.com",
            projectId: "myappleid-ee18a",
            storageBucket: "myappleid-ee18a.appspot.com",
            messagingSenderId: "40491943534",
            appId: "1:40491943534:web:9749925ce42a462193c87f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // متغیرهای جهانی
        let currentUser = null;
        let isLoggedIn = false;
        let appleIdInventory = {
            'USA': [],
            'UK': [],
            'CANADA': []
        };
        
        // تابع نمایش مدال
        function showLogin() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function showRegister() {
            document.getElementById('registerModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // تابع ورود کاربر
        function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = {
                        name: userCredential.user.displayName || 'کاربر محترم',
                        email: userCredential.user.email,
                        uid: userCredential.user.uid
                    };
                    isLoggedIn = true;
                    closeModal('loginModal');
                    updateHeader();
                    loadUserData();
                    alert('ورود موفقیت‌آمیز بود!');
                })
                .catch((error) => {
                    alert('خطا در ورود: ' + error.message);
                });
        }

        // تابع ثبت‌نام کاربر
        function register(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // ذخیره اطلاعات کاربر در دیتابیس
                    return db.ref('users/' + userCredential.user.uid).set({
                        name: name,
                        email: email,
                        joinDate: new Date().toLocaleDateString('fa-IR')
                    });
                })
                .then(() => {
                    currentUser = {
                        name: name,
                        email: email,
                        uid: auth.currentUser.uid
                    };
                    isLoggedIn = true;
                    closeModal('registerModal');
                    updateHeader();
                    loadUserData();
                    alert('ثبت‌نام موفقیت‌آمیز بود!');
                })
                .catch((error) => {
                    alert('خطا در ثبت‌نام: ' + error.message);
                });
        }

        // تابع بارگذاری اطلاعات کاربر
        function loadUserData() {
            if (!currentUser) return;
            
            db.ref('users/' + currentUser.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        document.getElementById('userName').textContent = userData.name;
                        document.getElementById('userEmail').textContent = userData.email;
                        document.getElementById('memberSince').textContent = userData.joinDate;
                    }
                });
        }

        // تابع نمایش پنل کاربری
        function showDashboard() {
            if (!isLoggedIn) {
                alert('لطفاً ابتدا وارد حساب کاربری خود شوید');
                showLogin();
                return;
            }
            
            loadPurchaseHistory();
            document.getElementById('dashboardModal').style.display = 'block';
        }

        // تابع بارگذاری تاریخچه خریدها
        function loadPurchaseHistory() {
            if (!currentUser) return;
            
            db.ref('purchases').orderByChild('userId').equalTo(currentUser.email).once('value')
                .then((snapshot) => {
                    const historyDiv = document.getElementById('purchaseHistory');
                    const purchases = snapshot.val();
                    
                    if (!purchases) {
                        historyDiv.innerHTML = '<div class="text-gray-500 text-center py-4">هنوز خریدی انجام نداده‌اید</div>';
                        return;
                    }
                    
                    historyDiv.innerHTML = '';
                    Object.values(purchases).reverse().forEach(purchase => {
                        const purchaseDiv = document.createElement('div');
                        purchaseDiv.className = 'bg-gray-100 p-3 rounded-lg';
                        purchaseDiv.innerHTML = `
                            <p class="font-semibold">اپل آیدی ${purchase.country}</p>
                            <p class="text-sm text-gray-600">${purchase.date} - ${purchase.price.toLocaleString('fa-IR')} تومان</p>
                            <p class="text-xs text-gray-500 mt-1">ایمیل: ${purchase.appleId}</p>
                        `;
                        historyDiv.appendChild(purchaseDiv);
                    });
                });
        }

        // تابع خرید اپل آیدی
        function buyAppleId(country) {
            if (!isLoggedIn) {
                alert('لطفاً ابتدا وارد حساب کاربری خود شوید');
                showLogin();
                return;
            }
            
            document.getElementById('countryName').textContent = country;
            document.getElementById('paymentResult').classList.add('hidden');
            document.getElementById('purchaseModal').style.display = 'block';
        }

        // تابع پرداخت
        function processPayment() {
            const country = document.getElementById('countryName').textContent;
            
            // دریافت یک اپل آیدی از موجودی
            db.ref('availableAppleIds/' + country).once('value')
                .then((snapshot) => {
                    const availableIds = snapshot.val();
                    if (!availableIds || Object.keys(availableIds).length === 0) {
                        throw new Error('موجودی تمام شد!');
                    }
                    
                    // انتخاب اولین اپل آیدی موجود
                    const firstKey = Object.keys(availableIds)[0];
                    const appleId = availableIds[firstKey];
                    
                    // حذف از موجودی
                    return db.ref('availableAppleIds/' + country + '/' + firstKey).remove()
                        .then(() => appleId);
                })
                .then((appleId) => {
                    // ثبت خرید
                    const purchaseData = {
                        userId: currentUser.email,
                        country: country,
                        appleId: appleId.email,
                        date: new Date().toLocaleDateString('fa-IR'),
                        price: 149000
                    };
                    
                    return db.ref('purchases').push(purchaseData)
                        .then(() => appleId);
                })
                .then((appleId) => {
                    // نمایش نتیجه به کاربر
                    document.getElementById('appleEmail').textContent = appleId.email;
                    document.getElementById('applePassword').textContent = appleId.password;
                    document.getElementById('paymentResult').classList.remove('hidden');
                    
                    // بروزرسانی موجودی
                    updateInventory();
                })
                .catch((error) => {
                    alert('خطا: ' + error.message);
                    closeModal('purchaseModal');
                });
        }

        // تابع بروزرسانی موجودی
        function updateInventory() {
            db.ref('availableAppleIds').once('value')
                .then((snapshot) => {
                    const data = snapshot.val() || {};
                    appleIdInventory = {
                        'USA': data.USA ? Object.values(data.USA) : [],
                        'UK': data.UK ? Object.values(data.UK) : [],
                        'CANADA': data.CANADA ? Object.values(data.CANADA) : []
                    };
                    updateButtonStatus();
                    updateAdminStats();
                });
        }

        // تابع بروزرسانی وضعیت دکمه‌های خرید
        function updateButtonStatus() {
            const countries = ['USA', 'UK', 'CANADA'];
            countries.forEach(country => {
                const buttons = document.querySelectorAll(`button[onclick="buyAppleId('${country}')"]`);
                buttons.forEach(button => {
                    if (appleIdInventory[country].length === 0) {
                        button.textContent = 'ناموجود';
                        button.disabled = true;
                        button.className = 'bg-gray-400 text-white px-6 py-2 rounded-lg cursor-not-allowed';
                    } else {
                        button.textContent = 'خرید';
                        button.disabled = false;
                        button.className = 'bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition';
                    }
                });
            });
        }

        // تابع افزودن نظر
        function addComment() {
            if (!isLoggedIn) {
                alert('لطفاً ابتدا وارد شوید');
                return;
            }
            
            const commentText = document.getElementById('newComment').value.trim();
            if (!commentText) return;
            
            const commentData = {
                userId: currentUser.uid,
                userName: currentUser.name,
                text: commentText,
                date: new Date().toLocaleDateString('fa-IR'),
                likes: 0,
                dislikes: 0
            };
            
            db.ref('comments').push(commentData)
                .then(() => {
                    document.getElementById('newComment').value = '';
                    loadComments();
                })
                .catch((error) => {
                    alert('خطا در ارسال نظر: ' + error.message);
                });
        }

        // تابع بارگذاری نظرات
        function loadComments() {
            db.ref('comments').once('value')
                .then((snapshot) => {
                    const commentsDiv = document.getElementById('reviews');
                    commentsDiv.innerHTML = '';
                    
                    snapshot.forEach((childSnapshot) => {
                        const comment = childSnapshot.val();
                        const commentId = childSnapshot.key;
                        
                        const commentHTML = `
                            <div class="border-b pb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                                            ${comment.userName.charAt(0)}
                                        </div>
                                        <span class="font-semibold">${comment.userName}</span>
                                    </div>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <button onclick="likeComment('${commentId}')" class="text-green-600 hover:text-green-700">
                                            👍 <span id="like-${commentId}">${comment.likes || 0}</span>
                                        </button>
                                        <button onclick="dislikeComment('${commentId}')" class="text-red-600 hover:text-red-700">
                                            👎 <span id="dislike-${commentId}">${comment.dislikes || 0}</span>
                                        </button>
                                    </div>
                                </div>
                                <p class="text-gray-700 mb-2">${comment.text}</p>
                                <div class="text-sm text-gray-500">${comment.date}</div>
                            </div>
                        `;
                        commentsDiv.innerHTML += commentHTML;
                    });
                });
        }

        // تابع لایک نظر
        function likeComment(commentId) {
            if (!isLoggedIn) {
                alert('لطفاً ابتدا وارد شوید');
                return;
            }
            
            db.ref('comments/' + commentId + '/likes').transaction((currentLikes) => {
                return (currentLikes || 0) + 1;
            });
        }

        // تابع دیسلایک نظر
        function dislikeComment(commentId) {
            if (!isLoggedIn) {
                alert('لطفاً ابتدا وارد شوید');
                return;
            }
            
            db.ref('comments/' + commentId + '/dislikes').transaction((currentDislikes) => {
                return (currentDislikes || 0) + 1;
            });
        }

        // تابع بروزرسانی هدر پس از ورود
        function updateHeader() {
            const headerButtons = document.querySelector('header .flex.items-center.space-x-4.space-x-reverse:last-child');
            
            if (isLoggedIn) {
                headerButtons.innerHTML = `
                    <button onclick="showDashboard()" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition">پنل کاربری</button>
                    <button onclick="logout()" class="border border-white px-4 py-2 rounded-lg hover:bg-white hover:text-blue-600 transition">خروج</button>
                `;
            } else {
                headerButtons.innerHTML = `
                    <button onclick="showLogin()" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition">ورود</button>
                    <button onclick="showRegister()" class="border border-white px-4 py-2 rounded-lg hover:bg-white hover:text-blue-600 transition">ثبت نام</button>
                `;
            }
        }

        // تابع خروج کاربر
        function logout() {
            auth.signOut()
                .then(() => {
                    currentUser = null;
                    isLoggedIn = false;
                    updateHeader();
                    alert('با موفقیت خارج شدید.');
                })
                .catch((error) => {
                    alert('خطا در خروج: ' + error.message);
                });
        }

        // توابع پنل مدیریت
        function openAdminPanel() {
            document.getElementById('adminPanel').style.display = 'block';
            updateAdminStats();
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }

        // تابع افزودن اپل آیدی جدید توسط ادمین
        function addAppleId(event) {
            event.preventDefault();
            const country = document.getElementById('appleIdCountry').value;
            const email = document.getElementById('appleIdEmail').value;
            const password = document.getElementById('appleIdPassword').value;
            
            const appleIdData = {
                email: email,
                password: password
            };
            
            db.ref('availableAppleIds/' + country).push(appleIdData)
                .then(() => {
                    alert('اپل آیدی با موفقیت اضافه شد!');
                    document.getElementById('appleIdCountry').value = '';
                    document.getElementById('appleIdEmail').value = '';
                    document.getElementById('appleIdPassword').value = '';
                    updateInventory();
                })
                .catch((error) => {
                    alert('خطا: ' + error.message);
                });
        }

        // تابع بروزرسانی آمار ادمین
        function updateAdminStats() {
            // محاسبه فروش امروز
            const today = new Date().toLocaleDateString('fa-IR');
            db.ref('purchases').once('value')
                .then((snapshot) => {
                    const purchases = snapshot.val() || {};
                    const allPurchases = Object.values(purchases);
                    
                    const todaySales = allPurchases.filter(p => p.date === today).length;
                    const todayRevenue = todaySales * 149000;
                    
                    document.getElementById('todaySales').textContent = todaySales;
                    document.getElementById('todayRevenue').textContent = todayRevenue.toLocaleString('fa-IR');
                    
                    // محاسبه فروش ماه
                    const monthSales = allPurchases.length;
                    const monthRevenue = monthSales * 149000;
                    
                    document.getElementById('monthSales').textContent = monthSales;
                    document.getElementById('monthRevenue').textContent = monthRevenue.toLocaleString('fa-IR');
                });
            
            // بروزرسانی موجودی
            document.getElementById('usaStock').textContent = appleIdInventory['USA'].length;
            document.getElementById('ukStock').textContent = appleIdInventory['UK'].length;
            document.getElementById('canadaStock').textContent = appleIdInventory['CANADA'].length;
        }

        // دسترسی ادمین با رمز عبور
        let adminSequence = [];
        document.addEventListener('keydown', function(e) {
            adminSequence.push(e.key);
            if (adminSequence.length > 10) adminSequence.shift();
            
            if (adminSequence.join('').includes('admin123')) {
                const password = prompt('رمز عبور پنل مدیریت را وارد کنید:');
                if (password === 'admin123') {
                    openAdminPanel();
                }
                adminSequence = [];
            }
        });

        // دسترسی ادمین با سه بار کلیک روی لوگو
        let tapCount = 0;
        document.querySelector('header svg').addEventListener('click', function() {
            tapCount++;
            
            if (tapCount >= 3) {
                const password = prompt('رمز عبور پنل مدیریت را وارد کنید:');
                if (password === 'admin123') {
                    openAdminPanel();
                }
                tapCount = 0;
            }
            
            setTimeout(() => { tapCount = 0; }, 3000);
        });

        // بستن مدال با کلیک خارج از آن
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal, .admin-panel');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // بارگذاری اولیه داده‌ها
        document.addEventListener('DOMContentLoaded', function() {
            // بررسی وضعیت ورود کاربر
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = {
                        name: user.displayName || 'کاربر محترم',
                        email: user.email,
                        uid: user.uid
                    };
                    isLoggedIn = true;
                    updateHeader();
                    loadUserData();
                }
            });
            
            // بارگذاری موجودی و نظرات
            updateInventory();
            loadComments();
        });
    </script>
</body>
</html>